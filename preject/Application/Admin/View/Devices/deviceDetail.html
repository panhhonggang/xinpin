<include file="Public/header" />
<div class="content">
    <include file="Public/nav" />
    <div class="row-fluid fl" id="main" style="background: #ecf0f5;">
        <div class="tableBox">
            <div class="titleBar">设备管理/<span>设备列表</span></div>
            <h1 class="deviceTitle text-center">当前设备：<span>{{$data['deviceid']}}</span>设备详情</h1>
            <div class="keyPointList">
                <div class="fl">
                    <h2 class="deviceStause">{{$data['devicestause']}}</h2>
                    <p>设备当前状态</p>
                </div>
                <div class="fl">
                    <h2>{{$data['puretds']}}</h2>
                    <p>设备当前原水值(ppm)</p>
                </div>
                <div class="fl">
                    <h2>{{$data['rawtds']}}</h2>
                    <p>设备当前净水值(ppm)</p>
                </div>
                <div class="fr">
                    <h2>{{$data['leasingmode']}}</h2>
                    <p>设备当前租赁模式</p>
                </div>
            </div>
            <div class="detailList container">
                <div class="fl leftBox ">
                    <div class=" filterInfo">
                        <h3>滤芯信息(剩余值)</h3>
                        <table class="table filterInfoTable"> 
                            <tbody>
                                
                               
                            </tbody>
                        </table>
                    </div>
                    <div class="deviceOperation">
                        <h3>设备操作</h3>
                        <a>
                            <button class="shutDown clickBtn"></button>
                        </a>
                    </div>
                </div>
                <div class="deviceInfo">
                    <h3>设备信息</h3>
                    <table class="table deviceInfoTable">
                        <tbody>
                            <tr>
                                <td>设备编号</td>
                                <td>{{$data['deviceid']}}</td> 
                            </tr>
                            <tr>
                                <td>设备状态</td>
                                <td>{{$data['devicestause']}}</td> 
                            </tr>
                            <tr>
                                <td>安装时间</td>
                                <td>{{$data['addtime']}}</td> 
                            </tr>
                            <tr>
                                <td>安装地址</td>
                                <td>{{$data['loaction']}}</td> 
                            </tr>
                            <tr>
                                <td>原水值 (ppm)</td>
                                <td>{{$data['puretds']}}</td> 
                            </tr>
                            <tr>
                                <td>纯水值 (ppm)</td>
                                <td>{{$data['rawtds']}}</td> 
                            </tr>
                            <tr>
                                <td>剩余流量 (L)</td>
                                <td>{{$data['reflow']}}</td> 
                            </tr>
                            <tr>
                                <td>剩余天数 (D)</td>
                                <td>{{$data['reday']}}</td> 
                            </tr>
                            <tr>
                                <td>租赁模式</td>
                                <td>{{$data['leasingmode']}}</td> 
                            </tr>
                            <tr>
                                <td>激活状态</td>
                                <td>{{$data['alivestause']}}</td> 
                            </tr>
                            <tr>
                                <td>滤芯模式</td>
                                <td>{{$data['filtermode']}}</td> 
                            </tr>
                            <tr>
                                <td>温度</td>
                                <td>{{$data['temperature']}}</td> 
                            </tr>
                            <tr>
                                <td>更新时间</td>
                                <td>{{$data['updatetime']}}</td> 
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination">
                        <ul>
                            
                        </ul>
                    </div>
                </div>
            </div>
            <!-- <div class="tableList">
                <h3>机主信息列表</h3>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <td>姓名</td>
                            <td>手机号码</td>
                            <td>地址</td>
                            <td>安装日期</td>
                            <td>备注</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>455</td>
                            <td>455</td>
                            <td>455</td>
                            <td>455</td>
                            <td>455</td>
                        </tr>
                    </tbody>
                </table>
                <div class="pagination">
                    <ul>
                        
                    </ul>
                </div>
            </div> -->
            <div class="tableList">
                <h3>经销商信息列表</h3>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <td>经销商ID</td>
                            <td>经销商姓名</td>
                            <td>手机号码</td>
                            <td>地址</td>
                            <td>管理级别</td>
                            <td>添加时间</td>
                            <td>邮箱</td>
                            <td>备注</td>
                        </tr>
                    </thead>
                    <tbody>
                        <volist name="chargelist['data']" id="vendors">
                            <tr>
                                <td>{{$vendors['id']}}</td>
                                <td>{{$vendors['name']}}</td>
                                <td>{{$vendors['phone']}}</td>
                                <td>{{$vendors['leavel']}}</td>
                                <td>{{$vendors['addtime']}}</td>
                                <td>{{$vendors['id']}}</td>
                                <td>{{$vendors['email']}}</td>
                                <td></td>
                            </tr>
                        </volist>
                    </tbody>
                </table>
                <div class="pagination">
                    <ul>
                        
                    </ul>
                </div>
            </div>
            <!-- <div class="tableList">
                <h3>设备充值记录</h3>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <td>设备ID</td>
                            <td>充值用户</td>
                            <td>手机号码</td>
                            <td>充值金额</td>
                            <td>充值日期</td>
                            <td>充值套餐</td>
                            <td>订单状态</td>
                            <td>备注</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>455</td>
                            <td>455</td>
                            <td>455</td>
                            <td>455</td>
                            <td>455</td>
                            <td>455</td>
                            <td>455</td>
                            <td>455</td>
                        </tr>
                    </tbody>
                </table>
                <div class="pagination">
                    <ul>
                       
                    </ul>
                </div>
            </div> -->
            <div class="tableList">
                <h3>使用记录</h3>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <td>序号</td>
                            <td>IC卡编号</td>
                            <td>用户姓名</td>
                            <td>手机号码</td>
                            <td>使用时间</td>
                            <td>使用流量/mL</td>
                            <td>使用地址</td>
                            <td>备注</td>
                        </tr>
                    </thead>
                    <tbody>
                        <volist name="chargelist['data']" id="vo">
                            <tr>
                                <td>{{$i}}</td>
                                <td>{{$vo.iccard}}</td>
                                <td>{{$vo.name}}</td>
                                <td>{{$vo.phone}}</td>
                                <td>{{$vo.time}}</td>
                                <td>{{$vo.flow}}</td>
                                <td>{{$vo.address}}</td>
                                <td>是空的</td>
                            </tr>
                        </volist>
                    </tbody>
                </table>
                <div class="pagination">
                    <ul>
                        
                    </ul>
                </div>
            </div>
        </div>
        <include file="Public/footer" />
    </div>
</div>

<script>
    var PackNum=0;
    //开关机按钮
    if($(".deviceStause").text()=="关机"){
        $(".shutDown").text("开机");
    }else{
        $(".shutDown").text("关机");
    }
    //滤芯显示
    var str='reflowfilter';
    var filterHtml='';
    var filterList=[];//字符串数组
    var filterText=[];//文本数组
    var data = {{$data|json_encode}};
    for(var i=1;i<20;i++){
        if(data['reflowfilter'+i] >= 0){
            filterList['reflowfilter'+i] = data['reflowfilter'+i];
            filterList['length'] = i;
        }
    }
    for(var i=1;i<=filterList['length'];i++){
        filterText[i]="滤芯"+i;
    }
    for(var i=1;i<=filterList['length'];i++){
        if(filterList['reflowfilter'+i]>100){//设置剩余滤芯值不能超过100%;
            filterList['reflowfilter'+i]=100;
        }else{
            filterList['reflowfilter'+i]=filterList['reflowfilter'+i];
        }
        filterHtml+='<tr><td>' + filterText[i] + '</td><td><div class="surplusBg"><p class="surplusShowColor" style="width:'+ filterList['reflowfilter'+i] +'%"></p></div></td><td><span class="surplusNum2">'+ filterList['reflowfilter'+i] +'</span>%</td><td><button class="resetBtn clickBtn"name="2">复位</button></td></tr>';
        // console.log(i);
    }
    $(".filterInfoTable tbody").html(filterHtml);
    //websoket
    var websoket= new WebSocket("ws://120.79.0.105:6001");
    websoket.onopen=function(){
        var deviceId=$(".deviceTitle span").text();//设备id
         ajson={
                        "DeviceID":deviceId,
                        "PackType":"login",
                        "Vison":0,
                    };
        websoket.send(JSON.stringify(ajson));
    }
    //按钮操作
    $('.clickBtn').click(function(){
        var thisT=$(this);
        var _this=$(this).text();
        var filterN = $(this).attr('name');
        var deviceId=$(".deviceTitle span").text();//设备id
        var ajson;//数据对象

        if(_this!="复位"){
            var tipsText = "确定要"+ _this + deviceId +"吗？";
        } else {
            var tipsText = "确定要"+ _this + "<a>滤芯" + filterN +"</a>吗";
        }

        layui.use('layer', function(){
            var layer = layui.layer;
            layer.confirm(tipsText, {icon: 3, title:'温馨提示'}, function(index){
                layer.close(index);
                ajson={
                        "DeviceID":deviceId,
                        "PackType":"SetData",
                        "Vison":0,
                        "PackNum":PackNum,
                    };  
                if(_this=="开机"){
                    ajson['DeviceStause']=8;
                    
                }else if(_this=="关机"){
                    ajson['DeviceStause']=7;
                }else if(_this=="复位"){
                    ajson['ReFlowFilter'+filterN]=0;
                    ajson['ReDayFilter'+filterN]=0;
                }
                websoket.send(JSON.stringify(ajson));
                // console.log(ajson);
                websoket.onmessage=function(event){
                    // console.log(124564);
                    var data=event.data;
                    var obj=JSON.parse(data); 
                    console.log(data);

                    if(obj.IsSuccess=='1'){
                        f(PackNum==obj.PackNum)
                        {
                           if(_this=="开机"){
                            thisT.text("关机");
                            }else if(_this=="关机"){
                                thisT.text("开机");
                                $(".deviceStause").text("关机");
                            }else if(_this=="复位"){
                                i
                                thisT.parent().siblings().children(".surplusNum2").text(100);
                                thisT.parent().siblings().children(".surplusBg p").width(100);

                            };
                           // PackNum++; 
                        }
                        

                    }else{
                        console.log(124);
                    }
                }
                
            });
        });
    });
</script>